<script context="module">

  export function deleteImage(imageId) {
    var desertRef = get(storage).ref().child(`${get(domainInfo).domainName}/${get(domainInfo).page}/images/${imageId}`);
    desertRef.delete().then(function() {
      console.log('deleted')
    }).catch(function(error) {
      console.error(error)
    });
  }

</script>

<script>
  import { domainInfo } from '@stores/data'
  import { get } from 'svelte/store'
  import Storage, {storage} from '@fb/storage'
  $: storageRef = $storage ? $storage.ref() : null

  import ShortUniqueId from "short-unique-id";
  const makeRandomID = () => new ShortUniqueId().randomUUID(5).toLowerCase();

  import { createEventDispatcher } from 'svelte'
  const dispatch = createEventDispatcher()

  export let imageUrl = '';
  let loading = false;
  let imageOrientation;

  function uploadImage(e) {

    const file = input.files[0];
    const imageId = makeRandomID();

    var url = URL.createObjectURL(file);
    var img = new Image;
    img.src = url;

    img.onload = function() {
      if (img.height > img.width) {
        imageOrientation = 'portrait'
      } else {
        imageOrientation = 'landscape'
      }
    };

    if (file) {

      loading = true;

      const uploadTask = storageRef.child(`${$domainInfo.domainName}/${$domainInfo.page}/images/${imageId}`).put(file);

      uploadTask.on('state_changed', function(snapshot){
        // event.attachment.setUploadProgress(snapshot.bytesTransferred / snapshot.totalBytes)
        switch (snapshot.state) {
          case 'paused': // or 'paused'
            // console.log('Upload is paused');
            break;
          case 'running': // or 'running'
            // console.log('Upload is running');
            break;
        }
      }, function(error) {
        alert('Failed to upload image')
      }, function() {
        uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
          loading = false;
          dispatch('submit', {
            url: downloadURL,
            orientation: imageOrientation,
            id: imageId
          })
        });
        // updateDatabase()
      });

    } else {
      console.error('No image uploaded')
    }

  }

  let input;
  
</script>

<Storage />

<!-- <label class="drop-box" for="drop-box-input">Upload an image</label> -->
<form class="control" on:submit|preventDefault={() => uploadImage(imageUrl)}>
  <label class="button is-link is-fullwidth" class:is-loading={loading}>
    Upload image
    <input on:change={uploadImage} bind:this={input} type="file" style="display:none" /> 
  </label>
</form>
<div class="field is-horizontal">
  <div class="field-label is-normal">
    <label class="label">Image URL</label>
  </div>
  <div class="field-body">
    <form class="field has-addons" on:submit|preventDefault={() => {
      loading = false
      dispatch('submit', { url: imageUrl} )
    }}>
      <div class="control is-expanded">
        <input bind:value={imageUrl} class="input" type="url" placeholder="https://images.pexels.com/photos/104827/cat-pet-animal-domestic-104827.jpeg">
      </div>
      <div class="control">
        <button class="button is-link" type="submit">
          Submit
        </button>
      </div>
    </form>
  </div>
</div>
<slot></slot>

<style>
  form {
    margin-bottom: 1rem;
  }
</style>