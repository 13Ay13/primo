<script>
  import { onMount, createEventDispatcher } from 'svelte'
  import { get } from 'svelte/store'
  import {ax,notify,checkIfUserHasSubdomain} from 'utils'
  import { User } from 'constructs'
  import {firebase,firebaseCore} from '@fb'
  import {addUser,getUserGithubAuthInfo} from '@fb/firestore/users'

  import { domainInfo, user } from '@stores/data'

  const dispatch = createEventDispatcher()

  let mounted = false
  onMount(() => {
    mounted = true
  })

  $: if ($firebase && !auth && mounted) { // needs to be mounted for dispatch to work (maybe cuz the module?)
    auth = $firebase.auth()
    dispatch('load')
  }

</script>

<script context="module">

  let auth

  export async function signOutUser() {

    let signOutSucessful = true;

    let errorCode;
    let errorMessage;

    try {
      let res = await auth.signOut()
    } catch(e) {
      // Handle Errors here.
      errorCode = e.code;
      errorMessage = e.message;
      console.log(errorCode, errorMessage)
      signOutSucessful = false
    }

    let blankUser = {...User()}
    blankUser.signedIn = !signOutSucessful
    user.set( blankUser )

    // window.location.reload()

    return {
      successful: signOutSucessful,
      code: errorCode || null,
      message: errorMessage || null
    }

  }

  export async function sendEmailVerification() {
    try {
      await auth.currentUser.sendEmailVerification()
      return {
        success: true
      }
    } catch(e) {
      console.error(e)
      return {
        success: false,
        message: e.message
      }
    }
  }

  export async function deleteUserAccount(password) {

    const { email } = get(user)

    auth.currentUser.delete().then(function() {
      // delete user doc 
      notify({
        title: 'User account deleted',
        message: email
      })
      console.log('deleted', email)
      user.set( User() )
    }).catch(function(error) {
      console.error(error)
    });
    
  }


  export async function checkIfLoggedIn() {
    const subdomain = get(domainInfo).domainName
    auth.onAuthStateChanged(async function(res) {
      if (res) {
        const userIsValid = await checkIfUserHasSubdomain(res.email, subdomain)
        if (subdomain === 'primo.press' || !subdomain || userIsValid) {
          user.set({
            ...res,
            verified: res.emailVerified,
            signedIn: true
          })

          const githubInfo = await getUserGithubAuthInfo()
          user.set({
            ...res,
            verified: res.emailVerified,
            ...githubInfo
          })
        } 
      }
    });

  }

  export async function signUpWithGithub(requestRepoAccess = false) {
    const firebase = get(firebaseCore)
    var provider = new firebase.auth.GithubAuthProvider();
    if (requestRepoAccess) provider.addScope('public_repo');
    return auth.signInWithPopup(provider).then(function(result) {
      // This gives you a GitHub Access Token. You can use it to access the GitHub API.
      var token = result.credential.accessToken;
      // The signed-in user info.
      var user = result.user;
      addUser(user.email, { type: 'github', githubUsername:result.additionalUserInfo.username, githubToken: token })
      return {
        user,
        githubUser: result.additionalUserInfo,
        token
      }
    }).catch(function(error) {
      var errorCode = error.code;
      var errorMessage = error.message;
      var email = error.email;
      var credential = error.credential;
      return {
        error: {
          code: errorCode,
          message: errorMessage
        }
      }
    });
  }


</script>