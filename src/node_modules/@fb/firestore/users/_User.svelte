<script>

  import { firestore, collections } from '../_store.js'
  import {Domain} from 'constructs'

  import { get } from 'svelte/store'
  import { domainInfo, user } from '@stores/data'

</script>

<script context="module">

  let usersCollection 
  let domainsCollection
  collections.subscribe(store => {
    if (store) {
      usersCollection = store.users
      domainsCollection = store.domains
    }
  })

  export async function addUser(email, data = {}) {
    let currentUser = usersCollection.doc(email)
    currentUser.set({
      type: 'email',
      ...data
    })
  } 

  export async function getUserGithubAuthInfo() {
    const { email } = get(user)
    const currentUserData = (await usersCollection.doc(email).get()).data()
    return {
      githubUsername: currentUserData.githubUsername,
      githubToken: currentUserData.githubToken
    }
  }

  export async function getUserDomains() {
    let { email } = get(user)
    let currentUserRef = usersCollection.doc(email)
    const pageRefSnapshot = await currentUserRef.collection('domains').get()
    const domains = pageRefSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
    return domains;
  }

  export async function getUserSubdomains() {
    let { email } = get(user)
    let currentUserRef = usersCollection.doc(email)
    const pageRefSnapshot = await currentUserRef.collection('subdomains').get()
    const subdomains = pageRefSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
    return subdomains;
  }

  export async function getUserRole() {
    const { email } = get(user)
    const domain = get(domainInfo).domainName
    let currentUserRef = usersCollection.doc(email)
    const domainSnapshot = await currentUserRef.collection('subdomains').doc(domain).get()
    return domainSnapshot.data()['role']
  }

  export async function getUserSubscriptions() {
    let { email } = get(user)
    let currentUser = usersCollection.doc(email)
    const pageRefSnapshot = await currentUser.collection('subscriptions').get()
    const subscriptions = pageRefSnapshot.docs.map(doc => ({
      hostname: doc.id,
      ...doc.data()
    }))
    return subscriptions;
  }

  export async function addSiteToUser(site) {

    let { email } = get(user)
    let currentUser = usersCollection.doc(email)

    currentUser.update({
      sites: firebase.firestore.FieldValue.arrayUnion(site)
    })

  }

  export async function getUserSites(email) {

    let userDoc = usersCollection.doc(email)

    const doc = await userDoc.get()
    const data = doc.data()
    return data.sites
  }

  export async function removeSiteFromUser(site) {

    let { email } = get(user)
    let currentUser = usersCollection.doc(email)
    currentUser.update({
      sites: firebase.firestore.FieldValue.arrayRemove(site)
    })

    deleteDocument(site.id)
  }

  export async function deleteDocument(pageId) {
    const domainRef = domainsCollection.doc(get(domainInfo).domainName)
    if (pageId !== 'index') {
      try {
        await domainRef.collection('pages').doc(pageId).delete()
        console.log(`Document ${ pageId } deleted`)
      } catch(e) {
        console.error("Error removing document: ", e);
      }
    } else {
      alert('Index page cannot be deleted')
    }
  }

  export async function addSubdomainToUser(subdomain) {
    const { email } = get(user)
    const currentUserRef = usersCollection.doc(email)
    const userSubdomainRef = currentUserRef.collection('subdomains').doc(subdomain)
    await userSubdomainRef.set({
      role: 'developer'
    })
  }

  export async function deleteSubdomainFromUser(subdomain) { 
    const { email } = get(user)
    const currentUserRef = usersCollection.doc(email)
    const userSubdomainRef = currentUserRef.collection('subdomains').doc(subdomain)
    userSubdomainRef.delete()
  }

  export async function addDomainToUser(domain) {
    const { hostname } = domain
    const { email } = get(user)
    const currentUserRef = usersCollection.doc(email)
    const userDomainRef = currentUserRef.collection('domains').doc(hostname)
    await userDomainRef.set({
      registration: Domain(domain),
      role: 'developer'
    })
  }

  export async function removeDomainFromUser(domain) {
    let { email } = get(user)
    let currentUser = usersCollection.doc(email)
    const domainRef = currentUser.collection('domains').doc(domain)
    domainRef.delete()
  }

  export async function addSubscriptionToUser(subscription, hostname) {
    let { email } = get(user)
    let currentUser = usersCollection.doc(email)
    const subscriptionRef = currentUser.collection('subscriptions').doc(hostname)
    await subscriptionRef.set({
      subscriptionId: subscription.id,
      started: subscription.current_period_start,
      renews: subscription.current_period_end,
      invoice: subscription.latest_invoice.hosted_invoice_url
    })
  }

  export async function removeSubscriptionFromUser(hostname) {
    let { email } = get(user)
    let currentUser = usersCollection.doc(email)
    const subscriptionRef = currentUser.collection('subscriptions').doc(hostname)

    let subscription = await subscriptionRef.get()
    await subscriptionRef.delete()
    console.log('successful deletion', subscription.data().subscriptionId)
    return subscription.data().subscriptionId
  }

  export async function getUserStripeId() {
    let { email } = get(user)
    let currentUser = await usersCollection.doc(email).get()
    return currentUser.data().stripeId
  }

  export async function setUserStripeId(stripeId) {
    let { email } = get(user)
    let currentUser = usersCollection.doc(email)
    await currentUser.update({ stripeId })
  }

  async function deleteAllUserPages(email) {
    const sites = await getUserSites(email).catch(e => {
      console.log('Could not get user sites', e)
      return []
    })
    if (sites.length > 0)  {
      sites.forEach(({url}) => {
        deleteDocument(url)
      })
    }
  }

  export async function deleteUserRecord() {
    let { email } = get(user)

    await deleteAllUserPages(email)

    let userToDelete = usersCollection.doc(email)
    return userToDelete.delete().then(function() {
      console.log(`Deleted ${email} from DB`);
      return true
    }).catch(function(error) {
      console.error(`Error deleting user: ${email}`, error);
      return false
    });
  }


</script>