<script lang="ts">
  import { onMount } from 'svelte'
  import {fade} from 'svelte/transition'
  import {sendSiteInvitation} from 'utils'
  import {addSiteCollaborator} from '@fb/firestore/domains'
  import {Spinner} from '@components/misc'

  import { modal } from '@stores/app'

  export let domain:string

  let email:string = ''
  let role:string = 'editor'
  let inviteSent:boolean = false

  onMount(() => {
    modal.show('INVITATION', { domain })
  })

  async function sendInvite():Promise<any> {
    loading = true
    await sendSiteInvitation(domain, email, role)
    await addSiteCollaborator(domain, email, role)
    inviteSent = true
    loading = false
  }

  let loading:boolean = false

</script>

{#if !loading && !inviteSent}
  <form
  on:submit|preventDefault={() => {
    sendInvite()
  }}>
    <label class="flex flex-col items-start">
      <span class="text-base mb-1 text-gray-900 font-semibold">Email</span>
      <input autofocus bind:value={email} type="email" placeholder="johndoe@gmail.com" />
    </label>

    <div class="mt-4">
      <span class="text-base text-gray-900 font-semibold">User Role</span>
      <div class="toggle">
        <button class:selected={role === 'editor'} type="button" on:click={() => role = 'editor'}>Content Editor</button>
        <button class:selected={role === 'dev'} type="button" on:click={() => role = 'dev'}>Developer</button>
      </div>
    </div>

    <div class="flex justify-end mt-8">
      <button class="bg-blue-600 text-white flex-1 py-2 rounded-sm font-semibold" type="submit" disabled={email.length <= 3}>Send Invite</button>
    </div>
  </form>
{:else if !inviteSent}
  <Spinner />
{:else}
  <div in:fade class="flex flex-col">
    <span class="font-medium text-xl">
      You invitation to collaborate on {domain} has been sent to {email} 
    </span>
    <form on:submit|preventDefault={() => modal.hide()} class="flex">
      <button class="bg-blue-600 text-white flex-1 py-2 rounded-sm font-semibold mt-4">Okay</button>
    </form>
  </div>
{/if}


<style>
  input {
    @apply text-base bg-gray-200 text-gray-900 font-medium rounded-sm py-2 px-3 flex-1;
  }
  .toggle {
    @apply flex mt-1 rounded-sm overflow-hidden;
  }
  .toggle > button {
    @apply flex-1 bg-gray-100 text-gray-700 py-2 font-medium transition-colors duration-200;
  }
  .toggle > button.selected {
    @apply bg-gray-800 text-gray-100 transition-colors duration-200 outline-none;
  }
  button[disabled] {
    @apply bg-blue-300 cursor-not-allowed transition-colors duration-200;
  }
</style>