<script lang="ts">
  import {onMount} from 'svelte'
  
  import {Button} from '@components/buttons'
  import FirebaseAuth, {signUpWithGithub} from '@fb/auth'
	import Firestore from '@fb/firestore'
  import {acceptInvitation} from '@fb/firestore/domains'
  import {addUser} from '@fb/firestore/users'
  import {Spinner} from '@components/misc'

  import {user} from '@stores/data'
  import {modal} from '@stores/app'

  export let domain:string
  export let email:string
  export let role:string

  async function signUpWithProvider(): Promise<any> {
    const {error:signupError, user:userInfo, githubUser, token} = await signUpWithGithub(true)
    if (signupError) {
      loading = false
      error = signupError.message
    } else if (userInfo.email !== email) {
      loading = false
      error = `Your Github email (${userInfo.email}) does not match your invitation email (${email}). Ask the owner of ${domain} to invite you at your Github email, or sign up for a Github account using the correct email address.`
    } else {
      await Promise.all([
        addUser(email),
        acceptInvitation(domain, email, role)
      ])
      user.set({
        ...userInfo,
        githubToken: token,
        githubUsername: githubUser.username,
        signedIn: true
      })
      // @ts-ignore Type 'string' is not assignable to type 'Location'
      // This is how we programmatically navigate
      window.location = `http://${domain}.${window.location.host}`
    }
  }

  let loading:boolean = false
  let password:string = ''
  let accepted:boolean = false

  let error = ''

</script>

<FirebaseAuth />
<Firestore />

<h1 class="text-xl font-medium text-gray-800">Collaborate as { role.slice(0,1) === 'e' ? 'an' : 'a'} {role} on {domain}</h1>
{#if error}
  <div class="bg-yellow-300 py-2 px-4 rounded-sm font-semibold text-gray-800 mt-4">{error}</div>
{/if} 
{#if !loading}
  <div>
    <label class="flex flex-row items-center justify-start mt-4">
      <input type="checkbox" class="mr-1" bind:checked={accepted}/>
      <span class="text-sm">Do you accept primo's <a class="text-blue-600 underline" href="https://www.iubenda.com/terms-and-conditions/39882203" target="blank">terms and conditions</a>?</span>
    </label>
    <button on:click={signUpWithProvider} disabled={!accepted} class="w-full bg-codeblack text-gray-100 py-2 mt-4 rounded font-medium hover:bg-gray-900 opacity-100 transition-opacity duration-100" type="button">
      <i class="fab fa-github mr-3"></i><span>Sign in with Github</span>
    </button>
  </div>
{:else}
  <Spinner />
{/if}


<style>
  button {
    @apply transition-colors duration-200;
  }
  button[disabled] {
    @apply opacity-75 cursor-not-allowed transition-opacity duration-100 !important;
  }
</style>