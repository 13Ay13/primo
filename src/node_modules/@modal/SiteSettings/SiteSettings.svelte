<script>  
  import _ from 'lodash'
  import {createEventDispatcher} from 'svelte'
  const dispatch = createEventDispatcher()
  import {PrimaryButton,SaveButton} from '@components/buttons'

  import {site} from '@stores/data'
  import {modal} from '@stores/app'

  import NavItemInput from './NavItemInput.svelte'
  import NavItem from './NavItem.svelte'
  import SettingsTitle from './SettingsTitle.svelte'

  // export let disableSave // TODO: Check if url already exists

  let navItems = _.cloneDeep($site.data.navItems)

  function updateNavItems(newNavItem, position) {
    navItems = navItems.map((item, i) => {
      if (i === position) return newNavItem
      else return item
    }).filter(item => item)

    navItemBeingEdited = null
  }

  let navItemBeingEdited = null

</script>

<SettingsTitle title="Site Navigation" info="Consumable from within custom component as `nav`" />

{#if navItems.length > 0 }
  {#each navItems as link, index }
    {#if index === navItemBeingEdited }
      <NavItemInput 
        {link}
        on:submit={({detail}) => updateNavItems(detail, index)} 
        on:cancel={() => updateNavItems(null, index)}
        variants="mb-4"
      />
    {:else}
      <NavItem 
        {link}
        {index}
        on:edit={() => navItemBeingEdited = index}
        on:remove={() => updateNavItems(null, index)}
      />
    {/if}
  {/each}
{/if}

{#if navItemBeingEdited === null}
  <PrimaryButton 
  on:click={() => {
    navItemBeingEdited = navItems.length
    navItems = [
      ...navItems,
      {
        link : '',
        label : ''
      }
    ]
  }}>Add new link</PrimaryButton>
{/if}

<div class="flex flex-row justify-end mt-4">
  <SaveButton on:click={() => {
    site.saveNav(navItems)
    modal.hide()
  }}>Save</SaveButton>
</div>