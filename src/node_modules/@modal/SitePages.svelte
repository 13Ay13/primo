<script>
  import _ from 'lodash'
  import {onMount,onDestroy} from 'svelte'
  import { link } from 'svelte-routing';
  import {fade} from 'svelte/transition'
  import {SelectOne,TextInput} from '@components/inputs'
  import {PrimaryButton} from '@components/buttons'
  import {Spinner,Card,Countdown} from '@components/misc'
  import {createPage as fbCreatePage, deletePage as fbDeletePage, getPagesInSubdomain} from '@fb/firestore/domains'
  import {getUniqueId, makeValidUrl} from 'utils'
  import PageItem from './PageList/PageItem.svelte'

  import { modal } from '@stores/app'
  import {domainInfo,site,pageData} from '@stores/data'

  let pages = []
  $: {
    pages = pages.map(p => ({ key: getUniqueId(), ...p })) // Add keys for templating (if one doesn't exist)
  }

  async function createPage(form) {
    const inputs = Object.values(form.target)
    const [ title, url ] = inputs.map(f => f.value)
    const isEmpty = inputs[2].classList.contains('selected')
    const newPage = isEmpty ? {
      id: url,
      title,
      content: [
        {
          id: getUniqueId(),
          width: 'contained',
          columns: [
            {
              id: getUniqueId(),
              size: 'w-full',
              rows: [
                {
                  id: getUniqueId(),
                  type: 'content',
                  value: {
                    html: '<p>some simple content</p>'
                  }
                }
              ]
            }
          ]
        }
      ],
      dependencies: {
        headEmbed : '',
        libraries: [],
        // customScripts: [],
      },
      settings: {
        globalStyles: {
          uncompiled: '',
          compiled: '',
          tailwindConfig: '{  theme: {    container: {      center: true    }  },  variants: {}}'
        },
        javascript: '',
        identity : {
          title, 
          url,
          description: ''
        }
      }
    } : $pageData // TODO: Apply 'duplicate' treatment, example in fbCreatePage
    site.pages.add(newPage)
    resetForm()
    pageBeingCreated = null
  }

  async function deletePage(pageUrl) {
    pages = pages.filter(p => p.url !== pageUrl)
    fbDeletePage(pageUrl)
  }

  let creatingPage = false

  let newPageTitle = ''
  let newPageUrl = ''
  let duplicate = false

  function resetForm () {
    newPageTitle = ''
    newPageUrl = ''
    duplicate = false
  }

  let pageBeingCreated
  let pageBeingDeleted

  let mounted = false
  onMount(async () => {
    // pages = (await getPagesInSubdomain()).map(page => page.settings.identity)
    mounted = true
  })

  const validateUrl = ({ detail }) => {
    newPageUrl = makeValidUrl(detail)
  }

</script>

{#each $site.pages as page (page.id+page.title)}
  <li transition:fade={{ duration: 200 }} id="page-{page.id}">
    <Card variants="bg-gray-100 shadow-sm mb-2 rounded p-4">
      <div slot="body">
        {#if page.id === $domainInfo.page} <!-- Current Page -->
          <!-- <PageItem {page} /> -->
          <p class="page-title flex flex-col mb-3">
            <span class="text-xs">{page.id === 'index' ? 'Homepage' : `/${page.id}`}</span>
            <span>{page.title || 'Untitled'}</span>
          </p>
        {:else if pageBeingDeleted !== page.id} <!-- Page -->
          <!-- <PageItem {page} /> -->
          <p class="page-title flex flex-col mb-3">
            <span class="text-xs">{page.id === 'index' ? 'Homepage' : `/${page.id}`}</span>
            <a href={page.id === 'index' ? '/' : page.id} on:click={() => modal.hide()} class="page-title">{page.title || 'Untitled'}</a>
          </p>
        {:else} <!-- Deleting page -->
          <p class="text-lg font-medium mb-2 inline-block">Deleting {page.title} ({page.id})</p>
        {/if}
      </div>
      <div slot="footer" class="w-full flex justify-end">
        {#if pageBeingCreated !== page.id && pageBeingDeleted !== page.id && page.id !== 'index'} <!-- Delete Button -->
          <button on:click={() => pageBeingDeleted = page.id} class="delete-page text-red-500 hover:text-red-700">
            <i class="fas fa-trash"></i>
          </button>
        {:else if pageBeingCreated !== page.id && page.id !== 'index'}  <!-- Page being deleted -->
          <Countdown time="500" variants="px-2 mb-3" on:end={() => deletePage(page.id)} on:undo={() => pageBeingDeleted = null}/>
        {/if}
      </div>
    </Card>
  </li>
{/each}

<div>
  {#if !creatingPage}
  <PrimaryButton on:click={() => creatingPage = true} id="new-page">New Page</PrimaryButton>
  {:else}
    <Card variants="p-4">
      <form on:submit|preventDefault={createPage} in:fade={{ duration: 100 }}>
        <TextInput id="page-title" autofocus={true} variants="mb-4" label="Page Title" bind:value={newPageTitle} placeholder="About Us" />
        <TextInput id="page-url" variants="mb-4" label="Page URL" prefix="/" bind:value={newPageUrl} on:input={validateUrl} placeholder="about-us" />
        <SelectOne 
          id="page-base"
          variants="mb-8"
          label="Page Base" 
          options={[ 'Empty', 'Duplicate' ]}
          on:select={({detail}) => duplicate = (detail === 'Duplicate')}
        />
        <PrimaryButton id="create-page" type='submit'>Create</PrimaryButton>
      </form>
    </Card>
  {/if}
</div>

<style>
  li {
    @apply list-none;
  }
  .page-title {
    @apply text-lg font-semibold transition-colors duration-100 items-start;
  }
  a.page-title {
    @apply underline text-blue-700;
  }
  a.page-title:hover {
    @apply text-blue-800;
  }
  button {
    @apply transition-colors duration-200;
  }
</style>