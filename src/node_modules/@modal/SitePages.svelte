<script>
  import _ from 'lodash'
  import {onMount,onDestroy} from 'svelte'
  import { link } from 'svelte-routing';
  import {fade} from 'svelte/transition'
  import {SelectOne,TextInput} from '@components/inputs'
  import {PrimaryButton} from '@components/buttons'
  import {Spinner,Card,Countdown} from '@components/misc'
  import {createPage as fbCreatePage, deletePage as fbDeletePage, getPagesInSubdomain} from '@fb/firestore/domains'
  import {getUniqueId, makeValidUrl} from 'utils'
  import PageItem from './PageList/PageItem.svelte'

  import { modal } from '@stores/app'
  import {domainInfo,site,pageData,tailwind} from '@stores/data'

  let pages = []
  $: {
    pages = pages.map(p => ({ key: getUniqueId(), ...p })) // Add keys for templating (if one doesn't exist)
  }

  async function createPage(form) {
    const inputs = Object.values(form.target)
    const [ title, url ] = inputs.map(f => f.value)
    const isEmpty = inputs[2].classList.contains('selected')
    const newPage = isEmpty ? {
      id: url,
      title,
      content: [
        {
          id: getUniqueId(),
          width: 'contained',
          columns: [
            {
              id: getUniqueId(),
              size: 'w-full',
              rows: [
                {
                  id: getUniqueId(),
                  type: 'content',
                  value: {
                    html: '<p>some simple content</p>'
                  }
                }
              ]
            }
          ]
        }
      ],
      dependencies: {
        headEmbed : '',
        libraries: [],
        // customScripts: [],
      },
      settings: {
        globalStyles: {
          uncompiled: '',
          compiled: '',
          tailwindConfig: '{  theme: {    container: {      center: true    }  },  variants: {}}'
        },
        javascript: '',
        identity : {
          title, 
          url,
          description: ''
        }
      }
    } : $pageData // TODO: Apply 'duplicate' treatment, example in fbCreatePage
    site.pages.add(newPage)
    creatingPage = false
    resetForm()
  }

  async function deletePage(pageId) {
    site.pages.remove(pageId)
  }

  let creatingPage = false

  let pageBeingCreated
  let pageBeingDeleted

  let mounted = false
  onMount(async () => {
    // pages = (await getPagesInSubdomain()).map(page => page.settings.identity)
    mounted = true
  })

  const validateUrl = ({ detail }) => {
    newPageUrl = makeValidUrl(detail)
  }

</script>

<ul class="grid grid-cols-2 gap-4">
  {#each $site.pages as page (page.id+page.title)}
    <li transition:fade={{ duration: 200 }} id="page-{page.id}">
      <div class="shadow-xl mb-4 rounded">
        <PageItem {page} />
        <div class="w-full flex justify-between px-3 py-2 border-t border-gray-100 ">
          <a class="text-xs font-semibold text-blue-500 underline hover:text-blue-800 transition-colors duration-200" href="/{page.id}">{page.title}</a>
          <div class="flex justify-end">
            {#if page.id !== 'index'}
              <button title="Delete page" on:click={() => deletePage(page.id)} class="delete-page text-xs text-yellow-800 hover:text-yellow-900">
                <i class="fas fa-trash"></i>
              </button>
            {/if}
          </div>
        </div>
      </div>
    </li>
  {/each}
</ul>

<div>
  {#if !creatingPage}
  <PrimaryButton on:click={() => creatingPage = true} id="new-page">New Page</PrimaryButton>
  {:else}
    <Card variants="p-4">
      <form on:submit|preventDefault={createPage} in:fade={{ duration: 100 }}>
        <TextInput id="page-title" autofocus={true} variants="mb-4" label="Page Title" placeholder="About Us" />
        <TextInput id="page-url" variants="mb-4" label="Page URL" prefix="/" on:input={validateUrl} placeholder="about-us" />
        <SelectOne 
          id="page-base"
          variants="mb-8"
          label="Page Base" 
          options={[ 'Empty', 'Duplicate' ]}
        />
        <PrimaryButton id="create-page" type='submit'>Create</PrimaryButton>
      </form>
    </Card>
  {/if}
</div>

<style>
  li {
    @apply list-none;
  }
  .page-title {
    @apply text-lg font-semibold transition-colors duration-100 items-start;
  }
  a.page-title {
    @apply underline text-blue-700;
  }
  a.page-title:hover {
    @apply text-blue-800;
  }
  button {
    @apply transition-colors duration-200;
  }
</style>