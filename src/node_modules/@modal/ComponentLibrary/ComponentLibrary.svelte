<script>
  import { createEventDispatcher, onMount, onDestroy } from 'svelte'
  const dispatch = createEventDispatcher()
  import _ from 'lodash'
  import {PrimaryButton} from '@components/buttons'

  import {getComponents,deleteComponentFromDomain,saveSymbolToDomain,updateInstancesInDomain} from '@fb/firestore/domains'
  import Container from './ComponentContainer.svelte'
  import {MODAL_TYPES} from 'const'
  import { wrapInStyleTags, getUniqueId, createInstance } from 'utils'

  import {modal} from '@stores/app'
  import {content,symbols} from '@stores/data'

  export let button;

  let componentBeingEdited = null
  function editComponent(component) {
    modal.show(
      'COMPONENT_EDITOR', 
      {
        component,
        button: {
          label: `Save ${component.title || 'Symbol'}`,
          onclick: async (symbol) => {
            modal.show('COMPONENT_LIBRARY', {button})
            await Promise.all([
              saveSymbolToDomain(symbol),
              updateInstancesInDomain(symbol),
              content.updateInstances(symbol)
            ])
            reloadComponents()
          }
        }
      }, 
      { 
        header: {
          title: `Edit ${component.title || 'Symbol'}`,
          icon: 'fas fa-th-large'
        } 
      }
    )
  }

  async function addComponent() {
    const component = {
      type: 'component',
      id: getUniqueId(),
      value: {
        raw: {
          css: '',
          html: '',
          js: '',
          fields: []
        },
        final: {
          css: '',
          html: '',
          js: '',
        }
      }
    }
    editComponent(component)
  }

  async function deleteComponent(component) {
    components = components.filter(c => c.id !== component.id)
    await deleteComponentFromDomain(component.id)
    reloadComponents()
  }

  let components = $symbols

  onMount(async() => {
    // reloadComponents()
  })

  async function reloadComponents() {
    const newSymbols = await symbols.reload()
    components = newSymbols
  }

  function addComponentToPage(symbol) {
    const instance = createInstance(symbol)
    button.onclick(instance)
  }

  function getID(component) {
    return component.id+component.value.final.html+component.value.final.css
  }

</script>

<PrimaryButton on:click={addComponent} variants="mb-4">
  <i class="fas fa-plus mr-1"></i>
  <span>Create New Symbol</span>
</PrimaryButton>

{#each components as component (getID(component))}
  <Container 
    on:edit={() => editComponent(component)}
    on:delete={() => deleteComponent(component)}
    on:select={() => addComponentToPage(component)}
    {component}
  />
{/each}