<script context="module">
  import {readable,writable} from 'svelte/store'
  export const email = writable('')
  export const password = writable('')
  export const resettingPassword = writable(false)
  export const warning = writable('')
  export const loading = writable(false)

</script>

<script>
  import {fade} from 'svelte/transition'

  import { createEventDispatcher, onMount } from 'svelte'
  let dispatch = createEventDispatcher()

  import FirebaseAuth, {signUpWithGithub,checkIfLoggedIn} from '@fb/auth'
  import FirebaseFirestore from '@fb/firestore'
  import {addUser,getUserRole} from '@fb/firestore/users'
  import { checkIfUserHasSubdomain } from 'utils'
  import Logo from './_Logo.svelte'
  import EmailInput from './_EmailInput.svelte'
  import PasswordInput from './_PasswordInput.svelte'
	import {Spinner} from '@components/misc'

  import {domainInfo,repo,user} from '@stores/data'
  import {modal,onDashboard} from '@stores/app'

  let emailSignupVisible = false

  async function signUpWithProvider() {
    const {error, user:userInfo, githubUser, token} = await signUpWithGithub(true)
    if (error) {
      warning.set(error.message)
    } else if ($onDashboard || await checkIfUserHasSubdomain(userInfo.email, $domainInfo.domainName)) {
      user.set({
        ...userInfo,
        githubToken: token,
        githubUsername: githubUser.username,
        signedIn: true
      })
      modal.hide()
    } else {
      loginError = `Could not log in. It looks like <strong>${userInfo.email}</strong> hasn't been invited to manage this site.`
    }
  }

  $: if($user.signedIn) {
    modal.hide()
  }

  let loginError

</script>

<Logo variants="mb-3" />
<hr />
<!-- {#if !loginError && !checkingIfLoggedIn} -->
{#if !loginError}
  <button id="signin-github" on:click={signUpWithProvider} class="w-full bg-codeblack text-gray-100 py-2 rounded font-medium hover:bg-gray-700 transition-colors duration-100" type="button">
    <i class="fab fa-github mr-3"></i><span>Sign in with Github</span>
  </button>
{:else}
  <span class="block p-4 bg-yellow-200">{@html loginError}</span>
{/if}


<svelte:head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous" />
</svelte:head>