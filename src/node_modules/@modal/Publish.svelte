<script>
  import { fade } from 'svelte/transition'
  import { createEventDispatcher } from 'svelte'
  import {setSubdomainRepo} from '@fb/firestore/domains'
  import {signUpWithGithub} from '@fb/auth'
  import {updateRepo} from 'utils'
  import axios from 'axios'
  import {Spinner} from '@components/misc'
  import {PrimaryButton} from '@components/buttons'

  import { repo, user } from '@stores/data'
  import {modal} from '@stores/app'

  let dispatch = createEventDispatcher();

  async function publishToRepo() {
    loading = true
    const username = $user.githubUsername
    feedback = `Creating repository`
    await createRepo()
    feedback = `Pusing files to repository`
    const newRepo = `${username}/${repoName}`
    const res = await updateRepo(newRepo, 'Initial Commit')
    if (!res) {
      attemptReauthentication(async () => {
        await createRepo()
        await setSubdomainRepo(newRepo)
        $repo = newRepo
        loading = false
        modal.hide()
      }, () => {
        alert('The page was saved, but could not be deployed to Github. Ensure that you have you have been added to the repository as a collaborator and try again.')
      })
    } else {
      setSubdomainRepo(newRepo)
      $repo = newRepo
      loading = false
      modal.hide()
    }

    async function createRepo() {
        // 1. Create a repo
        await axios.post(`https://api.github.com/user/repos?access_token=${$user.githubToken}`, {
          "name": repoName,
          "description": repoDescription,
          "private": repoVisibility,
          "auto_init": true
        }).catch(e => {console.error(e)})
        console.log('1. Created a repo', repoName)
      }
  }

  async function pushToRepo() {
    feedback = `Pusing files to repository`
    loading = true
    const res = await updateRepo($repo, commitMessage)
    if (!res) {
      attemptReauthentication(() => {
        finishPushing()
      }, () => {
        alert('The page was saved, but could not be deployed to Github. Ensure that you have you have been added to the repository as a collaborator and try again.')
      })
    } else {
      finishPushing()
    }

    function finishPushing() {
      feedback = 'Successfully pushed changes'
      setTimeout(() => modal.hide(), 2000)
    }
  }
  
  async function reAuthenticate() {
    try {
      const {error, user:userInfo, githubUser, token} = await signUpWithGithub(true)
      user.set({
        ...userInfo,
        githubToken: token,
        githubUsername: githubUser.username
      })
      return true
    } catch(e) {
      console.error(e)
      return false
    }
  }

  async function attemptReauthentication(onsuccess = () => {}, onfailure = () => {}) {
    const newRes = await reAuthenticate()
    if (newRes) {
      onsuccess()
    } else {
      onfailure()
    }
  }


  let buildToGithub = false
  let repoName = ''
  $: if (repoName.includes(' ')) repoName.replace(' ','')

  let repoDescription = ''
  let repoVisibility = false

  let feedback = ''
  let loading = false

  let commitMessage = ''

</script>

{#if !loading}
  {#if !$repo}
    {#if !buildToGithub}
      <div>
        <p class="text-gray-700 mb-4 text-sm">When you build your site to Github, it will be pushed as a static site. From there, you can deploy to any host you'd like (we recommend <a class="underline" href="https://vercel.com/docs/v2/git-integrations/vercel-for-github" target="blank" rel="noopener noreferrer">Vercel</a> and <a class="underline" href="https://www.netlify.com/blog/2016/09/29/a-step-by-step-guide-deploying-on-netlify/" target="blank" rel="noopener noreferrer">Netlify</a>).</p>
        <PrimaryButton on:click={() => buildToGithub = true}>
          <i class="fab fa-github mr-3"></i><span>Build to Github</span>
        </PrimaryButton>
      </div>
    {:else}
      <form on:submit|preventDefault={publishToRepo} in:fade={{ duration: 200 }}>
        <label class="flex flex-col items-start mb-4">
          <span class="text-base mb-1 text-gray-900 font-semibold">Name</span>
          <input bind:value={repoName} autofocus type="text" placeholder="my-primo-site" />
        </label>
        <label class="flex flex-col items-start">
          <span class="text-base mb-1 text-gray-900 font-semibold">Description</span>
          <textarea bind:value={repoDescription} rows="2" class="w-full"></textarea>
        </label>
        <div class="mt-4">
          <span class="text-base text-gray-900 font-semibold">Visibility</span>
          <div class="toggle">
            <button class:selected={!repoVisibility} type="button" on:click={() => repoVisibility = false}>Public</button>
            <button disabled title="Private repos temporarily unavailable" class:selected={repoVisibility} type="button" on:click={() => repoVisibility = true}>Private</button>
          </div>
        </div>
        <div class="flex justify-end mt-8">
          <button class="bg-codeblack hover:bg-gray-900 transition-colors duration-200 text-white flex-1 py-2 rounded-sm font-semibold" type="submit" disabled={!repoName}>Create repository</button>
        </div>
      </form>
    {/if}
  {:else if !buildToGithub}
    <form on:submit|preventDefault={pushToRepo} in:fade={{ duration: 200 }}>
      <label class="flex flex-col items-start mb-4">
        <p class="text-base mb-1 text-gray-900 font-semibold">Commit Message</p>
        <p class="text-gray-700 mb-4 text-sm">A commit message tells other collaborators what change was made to the website. The more descriptive you can be, the better.</p>
        <input class="w-full" bind:value={commitMessage} autofocus type="text" maxlength="50"/>
      </label>
      <div class="flex justify-end mt-4">
        <PrimaryButton disabled={!commitMessage} type="submit">Push changes</PrimaryButton>
      </div>
    </form>
  {/if}
{:else}
  {#if feedback}
    <div class="flex justify-center w-full">
      <p class="text-gray-700 mb-4 text-sm">{feedback}</p>
    </div>
  {/if}
  <Spinner />
{/if}

<style>
  input, textarea {
    @apply text-base bg-gray-200 text-gray-900 font-medium rounded-sm py-2 px-3 flex-1;
  }
  .toggle {
    @apply flex mt-1 rounded-sm overflow-hidden;
  }
  .toggle > button {
    @apply flex-1 bg-gray-100 text-gray-700 py-2 font-medium transition-colors duration-200;
  }
  .toggle > button.selected {
    @apply bg-gray-800 text-gray-100 transition-colors duration-200 outline-none;
  }
  button[disabled] {
    @apply text-white bg-blue-300 cursor-not-allowed transition-colors duration-200 !important;
  }
</style>