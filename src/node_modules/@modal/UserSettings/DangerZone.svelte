<script>
  import { slide } from 'svelte/transition'
  import { createEventDispatcher } from 'svelte'
  const dispatch = createEventDispatcher() 
  import { deleteUserAccount } from '@fb/auth'
  import {deleteUserRecord} from '@fb/firestore/users'
  import {user} from '@stores/data'
  import {User} from 'constructs'

  let deletingAccount = false
  let typedPw = '';
  let typedConfirmation = '';
  $: canDeleteAccount = (typedPw.length >= 1) && (typedConfirmation === 'I understand I am irreversibly deleting my account and websites')

  function beginAccountDeletion() {
    deletingAccount = true;
  }
  function undoAccountDeletion() {
    deletingAccount = false;
    typedPw = '';
    typedConfirmation = '';
  }
  
  async function finalizeAccountDeletion() {
    // const passwordCorrect = await validatePassword(typedPw)
    if (passwordCorrect) {
      let deletedRecord = await deleteUserRecord()
      if (deletedRecord) await deleteUserAccount()
      dispatch('delete')
      user.set( User() )
    } else {
      alert('Could not delete your account. Make sure your password is correct.')
    }
  }

</script>

<label class="label">Danger Zone</label>
{#if deletingAccount}
  <article class="message is-danger" transition:slide>
    <div class="message-header">
      <p>Deleting Account</p>
      <button class="delete" aria-label="delete" on:click={undoAccountDeletion}></button>
    </div>
    <div class="message-body">
      <strong>Deleting your account will also delete all of your websites</strong><br>
      <strong>This cannot be reversed</strong>
      <br><br>
      <div class="field">
        <label class="label">Enter your password</label>
        <div class="control">
          <input class="input" type="password" bind:value={typedPw}>
        </div>
      </div>
      <div class="field">
        <label class="label">Type 'I understand I am irreversibly deleting my account and websites'</label>
        <div class="control">
          <input class="input" type="text" bind:value={typedConfirmation}>
        </div>
      </div>
      <button class="button is-danger is-large is-fullwidth" on:click={finalizeAccountDeletion} disabled={!canDeleteAccount}>Delete account</button>
    </div>
  </article>
{:else}
  <button class="button is-danger" on:click={beginAccountDeletion}>Delete account</button>
{/if}