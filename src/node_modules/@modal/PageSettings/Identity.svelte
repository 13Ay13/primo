<script>
  import { fade } from 'svelte/transition'
  import { createEventDispatcher, onMount } from 'svelte'
  const dispatch = createEventDispatcher()

  import { checkIfUrlTaken } from '@fb/firestore/domains'
  import { Theme } from 'constructs'
  import {GenericField as Field} from '@components/inputs'

  import { domainInfo } from '@stores/data'

  const isHomePage = $domainInfo.page === 'index'

  export let identity
  export let disableSave = false

  let title = identity.title
  let url = identity.url
  let description = identity.description
  
  let urlTaken = false;
  $: urlChanged = ($domainInfo.page !== url)
  $: !isHomePage && validateUrl(url)
  async function validateUrl(newUrl) {
    if (newUrl.length >= 3) {
      urlTooShort = false;
      urlTaken = urlChanged && await checkIfUrlTaken(newUrl)
    } else urlTooShort = true;
  }

  let urlTooShort = false

  $: {

    dispatch('save', {
      title,
      url,
      description
    })

    disableSave = (urlTaken || urlTooShort)

  }

  $: urlNotice = urlTooShort || urlTaken || urlChanged

</script>


<Field leftlabel="Title" bind:value={title} input={{ id: 'title-input', placeholder: 'My Primo Page' }} />

<div class="field is-horizontal">
  <div class="field-label is-normal">
    <label class="label">URL</label>
  </div>
  <div class="field-body">
    <div class="field has-addons">
      <div class="control">
        <div class="button is-static">
          {$domainInfo.domainName}
        </div>
      </div>
      {#if !isHomePage}
        <div class="control has-icons-right is-expanded">
          <input class="input" id="url-input" class:is-danger={urlTaken || urlTooShort} type="text" placeholder="my-primo-page" bind:value={url}>
          <span class="icon is-small is-right">
            <i class="fas" class:fa-exclamation-triangle={urlTaken || urlTooShort}></i>
          </span>
        </div>
      {/if}
    </div>
  </div>
</div>
{#if !isHomePage && (urlNotice)}
  <div class="field is-horizontal">
    <div class="field-body">
      {#if urlTooShort}
        <p in:fade class="help is-danger">That URL should be at least 3 characters long</p>
      {:else if urlTaken}
        <p in:fade class="help is-danger">That URL has already been taken</p>
      {:else if urlChanged}
        <p class="help is-success">This URL is available</p>
      {/if}
    </div>
  </div>
{/if}

<Field leftlabel="Description" title="Used for SEO">
  <textarea class="textarea" placeholder="This is the page description" bind:value={description} rows="3"></textarea>
</Field>

<style>

</style>