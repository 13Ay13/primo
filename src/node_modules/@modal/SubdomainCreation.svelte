<script>
  import {Spinner} from '@components/misc'
  import {registerSubdomain,deregisterSubdomain,checkIfSubdomainExists} from '@fb/firestore/domains'
  import {addSubdomainToUser,getUserSubdomains}  from '@fb/firestore/users'
  import {modal} from '@stores/app'
  import {makeValidUrl} from 'utils'

  let loading;
  let subdomain = '';

  async function createNewSubdomain() {
    loading = true
    const unavailable = await checkIfSubdomainExists(subdomain)
    if (unavailable) {
      alert('That site name is unavailable, please try another.')
      loading = false
    } else {
      await addSubdomainToUser(subdomain)
      await registerSubdomain(subdomain)
      window.location.reload()
    }
  }

  const validateUrl = (e) => {
    subdomain = makeValidUrl(e.target.value)
  }
</script>


{#if !loading}
  <form on:submit|preventDefault={createNewSubdomain}>
    <label class="flex flex-col items-start my-4">
      <span class="text-base mb-1 text-gray-900 font-semibold">Site Address</span>
      <div class="flex flex-row justify-between w-full items-center bg-gray-300 rounded-sm">
        <input class="p-2 flex-1 bg-gray-100" bind:value={subdomain} on:input={validateUrl} type="text" placeholder="my-new-site" autofocus/>
        <span class="px-4 font-medium">.{window.location.host}</span>
      </div>
    </label>
    <div class="flex justify-end mt-8">
      <button class="submit-button" type="submit" disabled={subdomain.length <= 2}>Create</button>
    </div>
  </form>
{:else}
  <!-- <Spinner /> -->
  <h1 class="text-xl font-medium text-gray-800">Creating {subdomain}.{window.location.host}</h1>
{/if}

<style>
  .submit-button {
    @apply bg-blue-600 text-white flex-1 py-2 rounded-sm font-semibold transition-colors duration-200;
  }
  [disabled] {
    @apply bg-blue-300 cursor-not-allowed;
  }
</style>