<script>
  import {onMount} from 'svelte'
  import store from 'store2'
  import {site,settings as settingsStore,pageData} from '@stores/data'

  export let multiple = false
  export let pages = null
  export let id = null
  export let html = ''
  export let css = ''
  export let js = ''
  export let settings = null
  export let dependencies = null
  export let loading = false;

  export let includeParentStyles = false

  $: if (includeParentStyles) {
    css = $site.styles.final + $pageData.styles.final + css
  }

  var bc = new BroadcastChannel('preview');

  let ready = false
  bc.onmessage = () => {
    ready = true
  }

  $: multiple && ready && bc.postMessage(pages)

  $: store.set('preview', { 
    id,
    html,
    css,
    js,
    settings,
    dependencies
  })

  let iframe

  let timeout
  let cachedJs = js // reload the iframe whenever js changes to wipe the page's memory
  $: if (cachedJs !== js) {
    clearTimeout(timeout)
    timeout = setTimeout(() => {
      iframe.contentWindow.location.reload()
    }, 1000)
  }

  let iframeLoaded = false

</script>

<div class="h-full flex flex-col pl-2">
  <div class="preview-container flex-1" class:loading>
    <iframe on:load={() => {iframeLoaded = true}} class:fadein={iframeLoaded} title="Preview HTML" src="/?preview={multiple ? 'multiple' : true}" class="bg-white w-full h-full" bind:this={iframe}></iframe>
  </div>
  <a target="blank" class="preview-html" href="/?preview={multiple ? 'multiple' : true}">
    <span>open in separate tab</span>
    <span class="icon">
      <i class="fas fa-external-link-alt"></i>
    </span>
  </a>
</div>

<style>
  iframe {
    @apply opacity-0 transition-opacity duration-200;
  }
  .fadein {
    @apply opacity-100;
  }
  .preview-container {
    will-change: border-color;
    @apply border-4 border-solid transition-colors duration-500;
    border-bottom: 0;
    &.loading {
      border-color: rgb(248,68,73);
      & + .preview-html {
        @apply bg-primored text-white;
      }
    }
  }
  .preview-html {
    @apply w-full bg-gray-200 text-gray-600 text-xs py-2 rounded block text-center transition-colors duration-500;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    &:hover {
      @apply bg-gray-400;
    }
  }
</style>