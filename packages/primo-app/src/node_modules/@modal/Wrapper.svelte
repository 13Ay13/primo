<script>
  import { slide, fade } from 'svelte/transition'
  import _ from 'lodash'
  import { createEventDispatcher, onMount } from 'svelte'
  const dispatch = createEventDispatcher()
  import {Tabs} from '@components/misc'
  import {SaveButton} from '@components/buttons'
  import {CodeMirror} from '@components'
  import { parseHandlebars, convertFieldsToData } from 'utils'

  import {modal} from '@stores/app'
  import {pageData,site} from '@stores/data'

  let pageWrapper = _.cloneDeep($pageData.wrapper)
  let siteWrapper = _.cloneDeep($site.wrapper)

  const tabs = [
    {
      id: 'page',
      label: 'Page',
      icon: 'square'
    },
    {
      id: 'site',
      label: 'Site',
      icon: 'th'
    }
  ]

  let selectedTab = tabs[0]

  let disableSave = false

  function getAllFields() {
    const siteFields = _.cloneDeep($site.fields)
    const pageFields = _.cloneDeep($pageData.fields)
    const allFields = _.unionBy(siteFields, pageFields, "key");
    return allFields
  }

  async function updateHtmlWithFieldData(rawHTML) {
    const allFields = getAllFields()
    const data = await convertFieldsToData(allFields, 'all')
    const finalHTML = await parseHandlebars(rawHTML, data)
    return finalHTML
  }

</script>

<div class="flex flex-col">
  <Tabs {tabs} bind:activeTab={selectedTab} variants="mb-4" />
  <div class="flex-1">
    <span>head</span> 
    <CodeMirror 
      bind:value={pageWrapper.raw.head} 
      on:change={_.debounce( async() => { 
        pageWrapper.final.head = await updateHtmlWithFieldData(pageWrapper.raw.head)
      }, 1000 )}
      style="height:10rem" 
      mode={{
        name: 'handlebars',
        base: 'text/html'
      }}
    />

    <span>above body</span> 
    <CodeMirror 
    bind:value={pageWrapper.raw.above} 
    on:change={_.debounce( async() => { 
      pageWrapper.final.above = await updateHtmlWithFieldData(pageWrapper.raw.above)
    }, 1000 )}
    style="height:15rem" 
    mode={{
      name: 'handlebars',
      base: 'text/html'
    }}
  />

    <span>below body</span> 
    <CodeMirror 
      bind:value={pageWrapper.raw.below} 
      on:change={_.debounce( async() => { 
        pageWrapper.final.below = await updateHtmlWithFieldData(pageWrapper.raw.below)
      }, 1000 )}
      style="height:15rem" 
      mode={{
        name: 'handlebars',
        base: 'text/html'
      }}
    />
  </div>
  <div class="flex justify-end py-2">
    <SaveButton 
      on:click={() => {
        pageData.save('wrapper', pageWrapper)
        site.save({ wrapper: siteWrapper })
        modal.hide()
      }}>Save Wrapper</SaveButton>
  </div>
</div>
